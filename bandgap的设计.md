# Bandgap设计（一）
Bandgap是模拟电路里的重要角色，差不多可以说有模拟电路的地方就有bandgap。它的作用一般是提供各种参考电压和偏置电流。除非外加，否则还真缺不了它。
从原理上说，目前用的bandgap都离不开两个东西，一个是deltaVbe，一个是Vbe。前者产生的是一个kt/q形式电压，正比与温度。后者产生的是一个随温度准线性的电压，反比与温度。而bandgap的输出就则由这两个电压线性组合决定。理想情况下两种电压的温度系数刚好相反，就产生了0温度系数电压。至于实际为什么有温度系数，从最大的因素上说，就来自于Vbe，VBe只是随温度准线性，而另一个电压则是线性度很好的。
原理上知道了，在实际中怎么设计？Vbe好说，就是给二极管（或者说三极管）一个电流，取它的电压。deltaVbe则离不开一定形式的反馈，通过反馈使得两个不同的Vbe电压做差值。从大的角度讲，一种是用opa设计的，一种是用镜像电流镜设计的，从反馈的角度看，这两种电路是完全不同的。用opa设计的是一个负反馈，更严格的说，是有两个反馈支路，一正一负，而一定要负反馈强于正反馈，保证整个系统是负反馈。另一种结构是上面一个电流镜，下面一个电流镜，只是下面电流镜加了diode做degeneration。这个从系统的角度讲是正反馈，正反馈如果用在电路里，就一定要保证环路增益小于1才能稳定。由于稳定性的要求，所以这两种电路都不能随便把左右互换。至于仿真稳定性，对于用opa设计的负反馈电路，必须把正负反馈两个支路合起来仿真稳定性，否则仿真结果没有任何意义，因为单看一路信息不完整。对于正反馈，一般都是看看增益是否会超过1。
在一般的应用中，我很少碰到很强调温度系数的设计，这似乎和学校里的要求刚好相反。这也许是因为我设计的电路中ADC和DAC很多都不是测量用的。偶尔碰到那么几个，其指标也在10bit左右，看了看别人产品的datasheet，也只要求30-60ppm，并不是很高的指标。如何在工程上实现一个很好温度系数的bandgap呢？其实我也很感兴趣。这里是说工程上，主要是强调不是仿真也不是从流片中挑出一些。根据我的理解，要实现良好的温度系数必须依赖trim，否则单靠工艺是很难保证的。而trim就是根据测量到的输出去调整Vbe和/或deltaVbe的系数，将输出调整到一个目标值。为了正确trim，得区分不同因素造成的影响，一种是PTAT因素。如果一种误差来源是完全正比与温度的，那么一次校准就可以实现。这是由于我们在模拟电路的课本上已经知道，bandgap如果是理想的，那么在常温下的电压必须是一个常数才能保证温度系数最低（这个常数是和工艺相关的，一般在1.2V附近，恰好是硅的带隙宽度，所以我们把bandgap成为带隙基准源）。当存在其他PTAT因素之后，可以等效为kt/q的系数发生了变化，那么仍然只需要通过调整系数把常温电压校准到这个常数即可。另一种因素是非PTAT，比如Vbe的温度曲线就是弯曲的。那么原则上就必须在两个温度点测量才能知道Vbe的真实系数。还有一种因素是一个offset。比如直接给bandgap的输出加入一个offset，那么温度系数不受影响，但输出值发生了变化。此时如果还用之前的理论值作为目标，那么输出电压正确了，温度系数却会变差。因此这种offset必须在设计时就尽量减小。
上面说了，平时对bangap的温度特性关注的少。那么设计时关注什么呢？我更关心启动问题。这是由于启动本身是一种特殊情况，所以设计者很难准确掌握周边情况，那么该如何仿真？仿真的结果可靠不可靠，都是个大问题。而且bandgap通常负责为其他电路提供支持，bandgap出问题了，其他部分就很难测试了。
bandgap由于本身经常有多个平衡点，最常见的就是没有电流的情况，所以需要加入启动电路来破坏掉0这个平衡点。从原理上讲，0点本身也不是很稳定，在该点存在一个正反馈使得当存在波动时会脱离这个平衡点，有可能自己过渡到正常工作点，但在实际电路中当电路工作在这点时，通常增益都很小，因此小心还是无大错（当然也听说过有人不加启动电路，也同样正常工作甚至量产，这种就没法评论了）。启动电路也是一个利用负反馈的过程，只是非线性更强烈，而且最终一般控制到通或者不通的状态。通常的做法是利用一个电路感知bandgap支路的电流或者电压判断bandgap状态，然后把这个值放大（反相器就可以），再以注入电流的形式去改变bandgap支路的状态。注入的多少都会影响到启动。如果注入太少，可能依旧启动不起来。注入太多，就可能影响到bandgap支路本身的工作，导致启动电路无法关闭。
也看到过另一种启动电路，其实不算启动电路，而算por电路，就是检测上电，如果上电就注入电流，否则就关闭。还有一种是给bandgap支路提供一个恒定的电流源。所以在现实中是八仙过海，各显神通。如果非要说某种才最可靠，现实时不时会给人一个反例，认为不可靠的反而工作，认为可靠的反而不工作。如果真要深究，也许也能发现工作的，在某种状态下会不工作，不工作的，也许是设计时忽略了某些因素。但工程上往往没有太多的机会这么较真。想想QWERTY键盘获得成功的历史就知道了。
前面也说了，启动本身是个不很确定的状态，因此怎么仿真就是个大问题。万一仿真时假设是过程A，但在实际电路中经历的是过程B，A通过仿真确定没问题，B则未必。所以在仿真时，一方面需要尽可能遍历不同状态，比如不同的启动时间，不同的电压，不同的器件corner，不同的温度，不同的mismatch或者系统失配（所以理论上后仿真和蒙特卡洛是必须的），另一方面，最好从原理上确认一下启动的过程，如果有一些非理想因素启动电路能容忍多少。借用数字电路的术语，前者算是直接验证，后者算是形式验证。再就是启动同样是一个负反馈过程，因此原则上也有稳定性问题，只是工作点不像运放那么单一。根据别人的经验，通常需要关注一下启动的波形，避免相位裕度过低造成过冲或震荡。
 

