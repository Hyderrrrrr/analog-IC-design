# 电流镜的设计
电流镜是模拟电路里的一个基本单元，可以用于复制电流，也可以用作给差分对做负载。作为一个模块，一般设计考虑的参数包括电流的匹配，输出阻抗，输入阻抗，输出电压范围，有时还包括噪声。而可以调整的参数就包括电路的拓扑结构，管子的w和l。这些参数的设计大多数人都从教科书上掌握的很好了，这里就不再重复。
在实际设计中，一般很少把这么小的模块单独拿出来提些指标出来。所以很多时候需要自己根据电流镜所处的环境有个明确的概念。比如一般为了传送电流用的电流镜，输出阻抗多少算合适呢？这很少有明确的答案。我个人理解，一般电流在产生时都多多少少有偏差，而这个偏差通常很大（因为与片内电阻有关）。所以输出阻抗引入的偏差通常要远小于前者就可以了。而且这也取决于电源的波动情况，后级对输入电流的容忍情况。
在电流镜中，cascode是常用的，要比其他什么wilson之类的常用的多，因为简单而且设计方便。在设计cascode管的偏压时，书上给了几种方法，常用的还是1/4的二极管接法做偏压产生电路，如果不想浪费电流，可以用串电阻的方法。但是后者理论上不能保证当工艺变化时偏置电压可以同步变化（因为电阻的R与mos的特性可以是不相关的），而且面积相对也大一些。前一种方法，书上都讨论的是电流镜管和cascode管同样尺寸，让vds=vdsat，推导出偏压管是1/4。可是如果刚毕业的学生这样照猫画虎，就严重错了。因为cascode管通常不需要和电流镜管同样尺寸，而令vds=vdsat，则管子刚刚在饱和区的边缘，一方面此时的输出电阻还有些小，另一方面一旦存在误差，就很容易使输出电阻下降很多。再者，这是大尺寸下的简单公式，小尺寸下受各种因素干扰，未必合适。所以书上说的只是给指明了一个设计方向，而不是让设计者如此照猫画虎。为了保证输出电阻，更多的情况是为了给实际留margin，要让vds大于vdsat一两百mV，保证不同corner或者当存在mismatch，或者存在其他没想到的效应时（比如IR drop，比如版图效应），也能正常工作在饱和区。另一个问题就是如果cascode管和下面电流镜管子尺寸不同，有没有好的电路可以保证相对工艺不敏感？此时可以把那个二极管连接的mos拆成两个不同的管子，分开优化，原则上这样可以匹配性更好些，好处应该是在仿corner时，不容易出问题。
提到cascode，就说说同样是提高输出阻抗的wilson电流镜。这种电流镜看着非常不舒服，因为和我们的直观完全相反（请注意它下面两个管子的栅极接法和电流镜相反）。但是它也很有来历。在几十年前，有源器件非常昂贵，因此wilson电流镜可以用最小的器件数目做出输出阻抗倍增的电流镜，可以说是一种天才的想法。只是由于工艺的变化，使得这种做法优势不再。和普通的电流镜或者cascode电流镜不同（这基本是前馈结构），这个电路结构中存在负反馈，所以会感觉不习惯。负反馈需要考虑稳定性，就没有前馈的容易设计。但是负反馈也带来另一个好处，就是节点x的输入阻抗很低，比正常的gm-1还小gm*ro倍。利用这个特性，可以去偏置别的栅极，且不怕干扰。例如xx。
类似消失的做法还包括电流镜mos管下面的电阻。在bipolar时期，这个电阻经常出现。这是由于bipolar的gm很大，对电流镜来说这不是个好事情。因为gm大就导致对失配敏感，所以需要这种电阻做degeneration。但是在cmos里就不那么常用了，因为可以通过控制vdsat来控制gm，比使用电阻更节省面积。但是这种加电阻的方法也可以用于减小mos电流镜的flick noise，因此也不能说一定就没有用了。
在低电压下，电流镜也可以有新电路。目前看到的一种是把每个管子拆成两个串联，上面的W/L大，下面的小，下面的处于线性区，号称self biased cascode。但对此我持一定保留意见。如果是长沟器件，从原理上讲，其实完全可以替换成一个长L的器件来增加输出阻抗。而在小尺寸工艺下，就涉及许多小尺寸管子的特性。我曾经曾经用不同的工艺做过实验，对比self biased cascode和单独一个长沟的器件，其输出阻抗各有不同，对工艺的依赖很大，没有明确结论说self biased cascode一定好。。
和电流镜稍微有些关系的一个问题是，用作提供偏压的输出是否要加decouple 电容。这个问题很难回答。加电容好处是减小高频抖动，但坏处是低频恢复时间的增加。razavi的书上也只是提出来讨论，没给答案。也许就是说没有标准答案吧。我问过的其他人似乎也没有定量的方法去判断，很多时候更多的是从习惯出发加电容，因为还可以当作dummy用。从阻抗的角度看，加电流就是减小高频阻抗，当有外界干扰耦合到这个节点上时，节点电压的变动是正比与高频阻抗的。这就是wilson电流镜做偏置电压的好处，因为它同时改变了高低频阻抗
 

