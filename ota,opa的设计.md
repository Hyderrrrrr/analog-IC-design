Bandgap设计（三）
前面讨论了很多bandgap设计的理论问题。那么让我们在纸面上设计一个bandgap电路吧。我觉得用具体数值的方法来说明要比理论更直观。
首先我们需要一个Vbe。Vbe的大小在常温下一般都在0.6V左右，变化不大。这个值和beta与电流的关系都不是很密切。从厂家的数据中或者从仿真中都可以看到这个性质。因此我们给它的电流可以简单的设置为10uA，取个整数。那么为什么是0.6V呢？一种是从bipolar的电流公式入手，另一种也可以从具体数值入手。在0K时，理论上电压为硅的带隙电压，约1.2V，温度系数约-2mV/K，那么在室温300K时，自然就是0.6V。同时我们还需要一个deltaVbe。可以从公式知道如果电流相等，两个Vbe的差是kT/q*ln(N)，其中kT/q在室温下是26mV，斜率是0.086mV/K，N是bipolar面积的比。为了使两个斜率互相抵消，我们需要2/0.086=23.3倍的差距。这也可以看出deltaVbe是比较小的。N由于被ln了一下，因此N增加，面积线性增加，倍数却增加很缓慢。所以通常N可以取8方便版图。这样lnN就是2.08倍。所以还需要23.3/2.08=11.2倍的差距。这就需要一次电压电流转换来实现放大。就是把deltaVbe通过电阻R1转换为电流，然后再流经电阻R2，就变成了R2/R1倍的电压。所以我们需要两个约11倍关系的电阻，而电阻的大小根据电路的结构而定，很多时候是与Vbe的偏置电流有关的。deltaVbe本身很小，常温下只有52mV。在这个转换过程中一般离不开放大器，放大器有等效输入offset。那么这个offset会与52mV共同放大11倍。假定offset是5mV（通常都是这个量级），就会在输出变为55mV。对于1.2V输出的bandgap，其百分比大约是4.6%。换句话说，1.2V可能会偏5%左右。但是如果其他关系都是理想的，此时的温度系数近似为0。如果我们为了得到1.2V的输出，直接去trim bandgap的比例关系，那么反而得到一个比较差的温度系数。这种情况下，不如在bandgap输出之后增加一个新的放大比例，然后调整这个比例。当然在现实中还需要考虑工艺角的情况。有可能同样的电流情况下，bipolar的电压会偏10mV（具体看工艺），这样输出就直接变化10mV。在这种情况下bandgap电压变化了约1%。也有可能电阻偏了20%，那么给bipolar偏置的电流发生了变化，导致Vbe变化。由于电流变化是被ln化的，因此电阻偏20%的影响对Vbe的影响不会是20%，而是？？。这就是为什么在仿真corner时rfbs和rsbf的影响最大，mos的corner反而不重要。在这种情况下，bandgap的输出发生了变化，温度系数也发生了变化。但是教科书中也证明了，要让温度系数在某个点最低，其输出是一个固定电压。所以对这种情况，可以去trim电阻比例，使得输出恢复为理论值，温度系数也就最小。在实际的电路中，既有电路offset的影响，也有corner的影响，就使得这个情况复杂了。
上面的分析只给出了一阶的近似，而且不涉及具体的电路形式。但是从它出发，就很容易初步确定器件的各个参数。要进一步得到更高阶的特性，比如在一阶中认为是0的温度系数其实并不是0，那就需要进一步的分析其成因并加以优化。比如考虑到Vbe随温度变化的具体性质，就可以知道温度系数曲线一般是向下开口。而考虑到Vbe偏置电流是与电阻温度系数相关的，就可以进一步得到不同电阻对这个温度系数曲线变化量的影响。在这些情况下，理论推导和实际仿真是必不可少的。有时还得在流片测试后进一步修正。
OPA与OTA
我以前的导师考学生时很爱出两个题，让学生画一个dff，画一个opa，分别代表了数字电路和模拟电路的基本单元。有一种说法，学好了opa，就等于学好了模拟电路。opa（ota）就像模拟电路里的砖头一样，几乎处处可以碰到。说了这么多，就是为了强调opa在模拟电路中的地位。因此几乎每次面试，不论是考别人还是被别人考，几乎都能看到opa的题，问噪声，问输入范围，问cmrr，问psrr，问offset，更多是问miller 补偿。以至于在这里我都快想不出来opa还有哪些特性需要格外强调（当然这里只是说opa的基本结构，如果要讨论state of art的新结构，那估计可讨论的太多）。
说说miller补偿。miller补偿公式估计被大家背的滚瓜烂熟了。但是如何深入的去理解挺是一个问题。因为我们习惯了一个节点对应一个极点的思维，然后顶多就是通过miller效应改变了第一级的c，如果有人问你能否用miller效应计算输出级的极点，该如何回答呢？。另一种想法就是第二级也可以看成一个带反馈的放大器，cc也是反馈支路的一部分。用这种思路，就好理解nested miller opa的设计。也比较好理解有的文献中说的nested miller opa可以提高运放的thd（不仅仅是通过增加前级增益）。
miller补偿里我们当年还碰到一个陷阱。通常认为miller电容是gm*r*cc，那么当gm*r小于1怎么办？这个例子很简单，但是也提醒我们每时每刻都要记住所运用公式的前提是什么。每次出现陷阱大都是因为我们忽略了前提，胡乱用公式导致的（我想起了小学生做数学题最爱干的事情，就是凑答案）。
再贡献一个别人出的题目，一个opa，如果带的负载不是CL，而是一个电阻串一个电感，传输函数变成什么了？
说说opa的环路仿真。要仿真环路，必须做到DC连接，AC开路。DC连接，opa才能工作在正常的工作状态。文献中给出了不少方法，有大的RC（LC）断环路，有特殊开关断环路，但是这些都有共同的问题，就是保证了DC,但是在AC态时忽略了断开点后级对前级的影响。如果断开点后级对前级影响很小，那问题不大，不然仿真结果就有较大误差。所以现在stb仿真用的较多，按照软件自己的说法，它考虑了后级对前级的负载效应。
开关电容里的opa仿真也是个麻烦事。不知道大家注意到没有，开关电容电路并不是一个线性时不变电路，所以我们才会觉得那么的别扭，以往积累的经验都没法用。如果不是线性时不变电路，该怎么办？目前有两种思路，一种是近似简化，把它近似成线性时不变LTI的，另一种就是认为，时变就当时变去考虑。后一种就会用到pss，pac等新的仿真手段，但是好像目前还没有pstb，而且对于线形周期时变电路的稳定性判据，也不应该沿用以前LTI的稳定性判据。所以这种方法有优点也有缺点。前一种方法很好理解，假定时钟周期很长，那么在opa稳定的一段时间内，我们就可以认为这是LTI系统。但是请不要忽略掉这种方法的前提，否则又会掉进一些陷阱里。
我看到其他人最爱掉进去的另一个陷阱是cmfb电路的仿真。经常仿真出来bode图完全不像正常的样子，相位开始就翘上去，然后又下来，但是看pm也能看。如果仔细看过gray书中讲cmfb的部分，就知道，其实有两个cmfb环路在系统中。其中一个虽然对系统影响不大，但是如果断环断错了位置，我们仿的loop gain就和真正要看的完全不是一回事。也有的人避免了这个错误，是由于他没有接外面的另一个环路。但是从仿真的准确度以及仿真的稳定性角度说，外面的环路应该接上为好。
 

