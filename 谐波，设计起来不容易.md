谐波参数的设计
在模拟电路设计的各个参数里，我对谐波是最没有底的。首先，影响谐波的因素很多。针对不同的情况，需要区别不同的因素。对于opa这种，一般包括开环特性自身引入的，以及环路增益可以抑制的两部分。例如，如果opa自己带重负载很吃力，输出级的vgs很大才能提供足够的电路到输出，自然谐波特性比不上大输出级的。而前级增益越大自然也越容易在环路中通过反馈消除谐波。对于ota这种，则基本是开环特性。对于开关电容采样，则采样自身引入的谐波就与很多因素有关，例如开关的电阻是否与信号有关，采样的时刻是否与信号有关，采样时注入的电荷是否与信号有关等等。而针对da这种，又需要考虑在纯数字转到模拟时输出电阻，时序等等引入的谐波。针对不同的情况我们就需要了解谐波的来源才能做到有的放矢，因素很多，并且越是指标要求高，参与影响的因素就越多。很多在低指标下无关紧要的因素在高指标下就变成关键路径了。这些因素又是符合木桶定律的，即最短板的地方限制了系统的谐波特性。所以如果谐波不好，拼命提高其他参数无济于事。我印象最深的一件事就是有一次做带电阻负载的运放，谐波挺差只有50dB。当时找了一圈原因没找到，怀疑模型有问题，就把输出级加大。仿真看性能提升了不少，但实际测试只提升了一点。最后才发现是反馈点在版图中有轻微的寄生。虽然版图上只寄生了很小的电阻，但是由于负载和输出级本身电阻也不大，因此推算下来和实测很一致，最后也通过实验证实了这个怀疑。
其次，谐波本身是一个非线性的特性，因此各个因素之间存在耦合也并不奇怪。我以前有个推理，就是假设输出是理想的RC低通，那么如果采样也理想，那么理论上不会有任何问题，因为这可以等效为一个非常理想的线性电路。而线性电路是没有谐波存在的。但是这个推理在实践中是有很大问题的。这是由于推理过程中认为采样也很理想。如果采样有非线性的因素，而输出是低通，那么采样的非线性与理想的RC配合就会产生谐波。可能在设计中单独考虑各个因素都没问题了，但是当合起来之后就有了问题。或者在设计中没有任何问题，但在实际中却由于有没有考虑到的非理想因素导致新的问题。
最后，不得不说说数值方面的问题。前面的讨论也许都没有任何问题了，但是谐波是多少，仍然对这个没有任何的概念。顶多说应该不错或者应该有改善，但是具体数值，是很难事先掌握的。这是由于分析谐波时的思考方式与其他参数不同。其他很多参数都可以用线性电路的分析方法得出，有一套成熟技术。谐波必然是非线性过程的产物，而非线性过程是没有什么套路可用的。例如噪声虽然是随机过程，但是可以套用线性过程的计算方法，因此输入多少输出很容易计算出是多少，只是工作量的问题。谐波却不行。有人尝试做各种事先估计，例如用opa的增益变化来估计谐波，或者用简单的关系式代替具体的非线性关系来推算。不过这些方法的精度比我们对其他性能参数的估计能力差的多。所以瞬态仿真非常重要。但是仿真结果却非常的不靠谱。例如运放谐波与增益有密切关系，但是平时我们仿真的增益只要差不多精度就够了，因为我们几乎不用开环的增益做具体事情，都是用闭环的结果，所以增益仿真即使差20dB，从100变到80，我觉得几乎没有人测试或者注意到。但是对谐波测试就很明显的变化出现了。而增益的仿真也许也是不靠谱之一，因为IV曲线的拟合优先考虑曲线本身的误差，而增益却依赖于曲线的斜率。另外，谐波对数值计算的误差也非常敏感，选用不同的步长不同的简化算法，谐波几乎可以变化几十dB。因此必须学会区分数值计算带来的谐波和电路自身的谐波。EDA工具自己也尝试解决一些问题，例如spectre就有专门的分析用于谐波，比自己控制步长更可靠。不过很多时候还是不够用。谐波仿真依附于瞬态仿真，有时候速度过慢，每次结果不理想需要修改电路就很浪费时间。
有了这些限制，感觉谐波的设计定性多于定量，细节才是魔鬼，指标要求越高，对细节的要求对电路的理解就越重要。和其他参数的设计比，谐波优化更像绣花的精细活。 

